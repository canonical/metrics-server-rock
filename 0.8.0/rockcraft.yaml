name: metrics-server
summary: ROCK for the metrics-server Project.
description: >
  Metrics Server is a scalable, efficient source of container resource metrics
  for Kubernetes built-in autoscaling pipelines.
version: "0.8.0"
license: Apache-2.0

base: bare
build-base: ubuntu@22.04
platforms:
  amd64:
  arm64:

services:
  metrics-server:
    override: replace
    summary: "metrics-server service"
    startup: enabled
    command: "/metrics-server [ ]"
    on-failure: shutdown

entrypoint-service: metrics-server

parts:
  openssl:
    plugin: nil
    stage-packages:
      - openssl-fips-module-3 # a Pro only FIPS package for openssl
      - openssl # now automatically selected from fips-preview
  metrics-server:
    plugin: nil
    source: https://github.com/kubernetes-sigs/metrics-server.git
    source-type: git
    source-tag: v0.8.0
    source-depth: 1
    build-packages:
      - build-essential
    build-snaps:
      - go/1.24-fips/stable
    override-build: |
      snap refresh go --channel 1.24-fips/stable
      sed -i 's/CGO_ENABLED=0/CGO_ENABLED=1 GOTOOLCHAIN=local GOEXPERIMENT=opensslcrypto/' Makefile
      # Metrics-server does not provide a way to pass custom build tags, so we have to
      # modify the Makefile directly to add the required tags for FIPS support.
      sed -i 's/-trimpath/-trimpath -tags "linux,cgo,ms_tls13kdf"/' Makefile
      make build ARCH="${CRAFT_ARCH_BUILD_FOR}" BINARY_NAME=metrics-server
      ls $CRAFT_PART_BUILD/_output
      cp $CRAFT_PART_BUILD/_output/metrics-server $CRAFT_PART_INSTALL
      snap refresh go --channel 1.23-fips/stable
